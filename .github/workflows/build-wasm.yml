name: Build and Release WASM

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-wasm:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Swiftly
        run: |
          curl -O https://download.swift.org/swiftly/darwin/swiftly.pkg
          installer -pkg swiftly.pkg -target CurrentUserHomeDirectory
          export PATH="$HOME/.swiftly/bin:$PATH"
          echo "$HOME/.swiftly/bin" >> $GITHUB_PATH
          ~/.swiftly/bin/swiftly init --quiet-shell-followup
          swiftly --version
      
      - name: Install Swift 6.2.1 with WASM support
        run: |
          swiftly install 6.2.1
          swiftly use 6.2.1
          swift --version
      
      - name: Install WASM SDK
        run: |
          swift sdk install https://download.swift.org/swift-6.2.1-release/wasm-sdk/swift-6.2.1-RELEASE/swift-6.2.1-RELEASE_wasm.artifactbundle.tar.gz --checksum 482b9f95462b87bedfafca94a092cf9ec4496671ca13b43745097122d20f18af
          swift sdk list
      
      - name: Build WASM
        run: |
          swift build --swift-sdk swift-6.2.1-RELEASE_wasm -c release --product MobileWheelsDatabaseWasm -Xswiftc -Xclang-linker -Xswiftc -mexec-model=reactor
          ls -lh .build/wasm32-unknown-wasip1/release/
      
      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          cp .build/wasm32-unknown-wasip1/release/MobileWheelsDatabaseWasm.wasm release-assets/MobileWheelsDatabase.wasm
          ls -lh release-assets/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/MobileWheelsDatabase.wasm
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
