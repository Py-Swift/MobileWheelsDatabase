name: Build and Release WASM

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-wasm:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install SwiftWasm SDK
        run: |
          # Install latest SwiftWasm SDK using swift sdk install
          swift sdk install https://github.com/swiftwasm/swift/releases/download/swift-wasm-DEVELOPMENT-SNAPSHOT-2025-11-25-a/swift-wasm-DEVELOPMENT-SNAPSHOT-2025-11-25-a-wasm32-unknown-wasip1.artifactbundle.zip --checksum 16dcf39246733cdd1cdd94fa2542d1c0d6eb6241d642f549e6c52d3941a6885d
          swift sdk list
      
      - name: Build WASM
        run: |
          swift build --swift-sdk wasm32-unknown-wasip1 -c release --product MobileWheelsDatabaseWasm
          ls -lh .build/wasm32-unknown-wasip1/release/
      
      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          cp .build/wasm32-unknown-wasip1/release/MobileWheelsDatabaseWasm.wasm release-assets/MobileWheelsDatabase.wasm
          ls -lh release-assets/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/MobileWheelsDatabase.wasm
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
